use std::fs::File;
use std::io::Read;

use crate::huutonet::parse::api_parse_after;
use crate::vahti::VahtiItem;

#[test]
fn basic_parse() {
    let mut file = File::open("testdata/huutonet/basic_parse.json").expect("Test data not found");
    let mut contents = String::new();
    file.read_to_string(&mut contents).unwrap();

    let expected = VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: crate::huutonet::ID,
        title: "Tekniikan Maailma 20/1993".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/tekniikan-maailma-20_1993/575647318".to_string(),
        img_url: "https://kuvat.huuto.net/v1/a777/9ca312c77fbf51f301afec055e4/505225227-m.jpg"
            .to_string(),
        published: 1674021288,
        price: 4,
        seller_name: "kodin".to_string(),
        seller_id: 241366,
        location: "SAARENTAUS".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 575647318,
    };

    assert_eq!(
        *api_parse_after(&contents, 0).unwrap().first().unwrap(),
        expected
    );
}

#[test]
fn parse_after() {
    let mut file = File::open("testdata/huutonet/parse_after.json").expect("Test data not found");
    let mut contents = String::new();
    file.read_to_string(&mut contents).unwrap();

    assert_eq!(api_parse_after(&contents, 1669983035).unwrap().len(), 1);
    assert_eq!(api_parse_after(&contents, 1669983034).unwrap().len(), 2);
}

#[test]
fn parse_multiple() {
    let mut file =
        File::open("testdata/huutonet/parse_multiple.json").expect("Test data not found");
    let mut contents = String::new();
    file.read_to_string(&mut contents).unwrap();

    let mut expected = vec![
            VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad Workstation Dock telakointiasema".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-workstation-dock-telakointiasema/578236742".to_string(),
        img_url: "https://kuvat.huuto.net/v1/6082/695e42d788604ea88de676285aa/508366924-m.jpg".to_string(),
        published: 1678355586,
        price: 13,
        seller_name: "ITJari".to_string(),
        seller_id: 2732468,
        location: "HELSINKI".to_string(),
        ad_type: "auction".to_string(),
        ad_id: 578236742,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Sierra Wireless AirPrime 4G LTE".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/sierra-wireless-airprime-4g-lte/578174408".to_string(),
        img_url: "https://kuvat.huuto.net/v1/728e/66af711226504dfd72ba7f58e98/508288586-m.jpg".to_string(),
        published: 1678255722,
        price: 10,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 578174408,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad 65W slim -virtalähde".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-65w-slim--virtalahde/578086441".to_string(),
        img_url: "https://kuvat.huuto.net/v1/e2d6/c6fef7201d482325a798711b175/508181197-m.jpg".to_string(),
        published: 1678114915,
        price: 15,
        seller_name: "prossu1".to_string(),
        seller_id: 2366051,
        location: "OULU".to_string(),
        ad_type: "auction".to_string(),
        ad_id: 578086441,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad Quectel SDX24 EM120R-GL WWAN 4G modeemi".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-quectel-sdx24-em120r-gl-wwan-4g-modeemi/578085280".to_string(),
        img_url: "https://kuvat.huuto.net/v1/a1d5/c41fa515e150d20db90c614f981/507236793-m.jpg".to_string(),
        published: 1678113543,
        price: 82,
        seller_name: "tarsiger".to_string(),
        seller_id: 808553,
        location: "VANTAA".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 578085280,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Thinkpad W541 / P50  170W virtalähde".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/thinkpad-w541-_-p50--170w-virtalahde/578082963".to_string(),
        img_url: "https://kuvat.huuto.net/v1/827b/80cf9ca765dd302da0e5df02144/507234984-m.jpg".to_string(),
        published: 1678111203,
        price: 42,
        seller_name: "tarsiger".to_string(),
        seller_id: 808553,
        location: "VANTAA".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 578082963,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Thinkpad näppäimistö UK".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/thinkpad-nappaimisto-uk/578028877".to_string(),
        img_url: "https://kuvat.huuto.net/v1/3569/8614db847be72cec6cf7085879d/508110054-m.jpg".to_string(),
        published: 1678024148,
        price: 3,
        seller_name: "hnetti".to_string(),
        seller_id: 1456413,
        location: "HELSINKI".to_string(),
        ad_type: "auction".to_string(),
        ad_id: 578028877,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo Thinkpad T15 Gen 2 (20W400HGMX)".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-t15-gen-2-20w400hgmx/578026882".to_string(),
        img_url: "https://kuvat.huuto.net/v1/04e4/304693717970e81fa61d0e0b988/508107118-m.jpg".to_string(),
        published: 1678022037,
        price: 790,
        seller_name: "attekorte".to_string(),
        seller_id: 24060,
        location: "JUUKA".to_string(),
        ad_type: "auction".to_string(),
        ad_id: 578026882,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "ThinkPad Thunderbolt 3 Workstation Dock Gen 1 + 230W sekä 65".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/thinkpad-thunderbolt-3-workstation-dock-gen-1--230w-seka-65/578013764".to_string(),
        img_url: "https://kuvat.huuto.net/v1/b1ac/d2b7cf0db9ee812a1d4d5a747a6/505840652-m.jpg".to_string(),
        published: 1678006781,
        price: 125,
        seller_name: "tarsiger".to_string(),
        seller_id: 808553,
        location: "VANTAA".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 578013764,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo Thinkpad kosketuslevy E440 L440 T440 W540".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-kosketuslevy-e440-l440-t440-w540/577859186".to_string(),
        img_url: "https://kuvat.huuto.net/v1/e985/ac742e77b9ba14af63999f684a7/507888772-m.jpg".to_string(),
        published: 1677736062,
        price: 10,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577859186,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "16 GB DDR4 2666V SO-DIMM muistia".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/16-gb-ddr4-2666v-so-dimm-muistia/577756539".to_string(),
        img_url: "https://kuvat.huuto.net/v1/947d/a3662a375d2cfc001cc3807f0a8/507751477-m.jpg".to_string(),
        published: 1677589947,
        price: 50,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577756539,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad laturi 135W".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-laturi-135w/577619805".to_string(),
        img_url: "https://kuvat.huuto.net/v1/6b2d/0a6af834366a26eaeffb9a53379/507582568-m.jpg".to_string(),
        published: 1677406913,
        price: 20,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577619805,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo Thinkpad X270 M.2 levykelkka + NVMe SSD levy".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-x270-m2-levykelkka--nvme-ssd-levy/577619781".to_string(),
        img_url: "https://kuvat.huuto.net/v1/7e21/fa76d89f482de7d00a425a30fc5/507582527-m.jpg".to_string(),
        published: 1677406880,
        price: 50,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577619781,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo Thinkpad T470 M.2 levykelkka + NVMe SSD levy".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-t470-m2-levykelkka--nvme-ssd-levy/577619757".to_string(),
        img_url: "https://kuvat.huuto.net/v1/623c/e888f05644235d3d21167448bd2/507582487-m.jpg".to_string(),
        published: 1677406857,
        price: 50,
        seller_name: "nick00".to_string(),
        seller_id: 2914998,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577619757,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad läppärilaukku 15.6\"".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-lapparilaukku-156/577600532".to_string(),
        img_url: "https://kuvat.huuto.net/v1/214e/cf42a5ab8ee533cd6c22c88c2c7/507558554-m.jpg".to_string(),
        published: 1677369494,
        price: 15,
        seller_name: "Melviini".to_string(),
        seller_id: 2245306,
        location: "HELSINKI".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577600532,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad advanced minidock telakka ja laturi".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-advanced-minidock-telakka-ja-laturi/577519756".to_string(),
        img_url: "https://kuvat.huuto.net/v1/2204/5bd90ca1f70cc00a5135ec2ea8a/507461267-m.jpg".to_string(),
        published: 1677231594,
        price: 30,
        seller_name: "Joulubuggi".to_string(),
        seller_id: 2942,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 577519756,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "Lenovo ThinkPad T540p, 15.5\" 3K (2880 x 1620), IPS".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/lenovo-thinkpad-t540p-155-3k-2880-x-1620-ips/576827868".to_string(),
        img_url: "https://kuvat.huuto.net/v1/a71e/987ba35692c59217306a00185f6/506669279-m.jpg".to_string(),
        published: 1676145945,
        price: 600,
        seller_name: "hammermann".to_string(),
        seller_id: 1398678,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 576827868,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "IBM Thinkpad X20 + 2 kpl telakka".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/ibm-thinkpad-x20--2-kpl-telakka/576564494".to_string(),
        img_url: "https://kuvat.huuto.net/v1/4c37/1913a47d3811d624df9df4d93ce/506353523-m.jpg".to_string(),
        published: 1675671542,
        price: 400,
        seller_name: "hammermann".to_string(),
        seller_id: 1398678,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 576564494,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "IBM Thinkpad T43 + laturi + telakka +  Win XP Pro".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/ibm-thinkpad-t43--laturi--telakka---win-xp-pro/576378051".to_string(),
        img_url: "https://kuvat.huuto.net/v1/d904/7a54900391694410d3dab1343f6/506108127-m.jpg".to_string(),
        published: 1675324587,
        price: 250,
        seller_name: "hammermann".to_string(),
        seller_id: 1398678,
        location: "TAMPERE".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 576378051,
    },
    VahtiItem {
        deliver_to: None,
        delivery_method: None,
        site_id: 2,
        title: "512MB PC100 SODIMM".to_string(),
        vahti_url: None,
        url: "https://www.huuto.net/kohteet/512mb-pc100-sodimm/573442000".to_string(),
        img_url: "https://kuvat.huuto.net/v1/ab36/4c199038f4e8703cfc67aae5654/502037093-m.jpg".to_string(),
        published: 1670393684,
        price: 9,
        seller_name: "countryguy".to_string(),
        seller_id: 1304585,
        location: "IMATRA".to_string(),
        ad_type: "buy-now".to_string(),
        ad_id: 573442000,
    },
    ];

    let mut got = api_parse_after(&contents, 0).unwrap();

    expected.sort_by_key(|v| v.ad_id);
    got.sort_by_key(|v| v.ad_id);

    let _ = expected
        .iter()
        .zip(got.iter())
        .map(|(a, b)| assert_eq!(a, b))
        .collect::<Vec<_>>();
}
